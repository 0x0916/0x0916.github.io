<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>cgroup源码分析2——cgroup的初始化 - Notes about linux and my work</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="laoqinren" /><meta name="description" content="本文详细分析了cgroup初始化的过程。
本文基于3.10.0-862.el7.x86_64版本kernel进行分析。
" /><meta name="keywords" content="cgroup" />






<meta name="generator" content="Hugo 0.115.3 with theme even" />


<link rel="canonical" href="http://linux.laoqinren.net/kernel/cgroup-source-cgroup_init/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="cgroup源码分析2——cgroup的初始化" />
<meta property="og:description" content="本文详细分析了cgroup初始化的过程。

本文基于3.10.0-862.el7.x86_64版本kernel进行分析。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://linux.laoqinren.net/kernel/cgroup-source-cgroup_init/" /><meta property="article:section" content="kernel" />
<meta property="article:published_time" content="2018-08-23T22:50:33+08:00" />
<meta property="article:modified_time" content="2018-08-23T22:50:33+08:00" />
<meta itemprop="name" content="cgroup源码分析2——cgroup的初始化">
<meta itemprop="description" content="本文详细分析了cgroup初始化的过程。

本文基于3.10.0-862.el7.x86_64版本kernel进行分析。
"><meta itemprop="datePublished" content="2018-08-23T22:50:33+08:00" />
<meta itemprop="dateModified" content="2018-08-23T22:50:33+08:00" />
<meta itemprop="wordCount" content="6887">
<meta itemprop="keywords" content="kernel,linux,cgroup," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="cgroup源码分析2——cgroup的初始化"/>
<meta name="twitter:description" content="本文详细分析了cgroup初始化的过程。

本文基于3.10.0-862.el7.x86_64版本kernel进行分析。
"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Notes</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/linux/">
        <li class="mobile-menu-item">linux</li>
      </a><a href="/kernel/">
        <li class="mobile-menu-item">Kernel</li>
      </a><a href="/posts/">
        <li class="mobile-menu-item">Blog</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Notes</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/linux/">linux</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/kernel/">Kernel</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/posts/">Blog</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/archives/">Archives</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">cgroup源码分析2——cgroup的初始化</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-08-23 </span>
        <div class="post-category">
            <a href="/categories/kernel/"> kernel </a>
            <a href="/categories/cgroup/"> cgroup </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#cgroupfs_root-结构">cgroupfs_root 结构</a></li>
            <li><a href="#cgroup_subsys-结构">cgroup_subsys 结构</a></li>
            <li><a href="#几个全局变量">几个全局变量</a></li>
            <li><a href="#cgroups的初始化">cgroups的初始化</a></li>
            <li><a href="#proccgroups-实现分析">/proc/cgroups 实现分析</a></li>
            <li><a href="#crash-查看cgroup的一些数据结构的关系">crash 查看cgroup的一些数据结构的关系</a></li>
            <li><a href="#cgroup-subsys中的use_id">cgroup subsys中的use_id</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>本文详细分析了<code>cgroup</code>初始化的过程。</p>
<blockquote>
<p>本文基于<code>3.10.0-862.el7.x86_64</code>版本kernel进行分析。</p>
</blockquote>
<p>在分析初始化之前，我们需要看一下层级和子系统对应的结构体以及几个重要的全局变量。</p>
<p>层级对应的结构体为：<code>cgroupfs_root</code>，子系统对应的结构体为<code>cgroup_subsys</code>.</p>
<h3 id="cgroupfs_root-结构">cgroupfs_root 结构</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A cgroupfs_root represents the root of a cgroup hierarchy, and may be
</span></span></span><span class="line"><span class="cl"><span class="cm"> * associated with a superblock to form an active hierarchy.  This is
</span></span></span><span class="line"><span class="cl"><span class="cm"> * internal to cgroup core.  Don&#39;t access directly from controllers.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">cgroupfs_root</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * The bitmask of subsystems intended to be attached to this
</span></span></span><span class="line"><span class="cl"><span class="cm">         * hierarchy
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">subsys_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Unique id for this hierarchy. */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">hierarchy_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* The bitmask of subsystems currently attached to this hierarchy */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">actual_subsys_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* A list running through the attached subsystems */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">subsys_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* The root cgroup for this hierarchy */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">cgroup</span> <span class="n">top_cgroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Tracks how many cgroups are currently defined in hierarchy.*/</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">number_of_cgroups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* A list running through the active hierarchies */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">root_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* All cgroups on this root, cgroup_mutex protected */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">allcg_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Hierarchy-specific flags */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* IDs for cgroups in this hierarchy */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">ida</span> <span class="n">cgroup_ida</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* The path to use for release notifications. */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">release_agent_path</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* The name for this hierarchy - may be empty */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_CGROUP_ROOT_NAMELEN</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>sb</code>指向该层级关联的文件系统超级块</li>
<li><code>subsys_mask</code>和<code>actual_subsys_mask</code>分别指向将要附加到层级的子系统和现在实际附加到层级的子系统，在子系统附加到层级时使用。</li>
<li><code>hierarchy_id</code>是该层级唯一的id</li>
<li><code>top_cgroup</code>指向该层级的根cgroup</li>
<li><code>number_of_cgroups</code>记录该层级cgroup的个数</li>
<li><code>root_list</code>是一个嵌入的list_head，用于将系统所有的层级连成链表</li>
<li><code>subsys_list</code>是一个链表，该链表将附着于该挂载点上的子系统链接到一起</li>
</ul>
<h3 id="cgroup_subsys-结构">cgroup_subsys 结构</h3>
<p>子系统对应的数据结构为：<code>cgroup_subsys</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Control Group subsystem type.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * See Documentation/cgroups/cgroups.txt for details
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">cgroup_subsys</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">cgroup_subsys_state</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">css_alloc</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">cgrp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">css_online</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">cgrp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">css_offline</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">cgrp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">css_free</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">cgrp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">can_attach</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">cgrp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cgroup_taskset</span> <span class="o">*</span><span class="n">tset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cancel_attach</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">cgrp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cgroup_taskset</span> <span class="o">*</span><span class="n">tset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">attach</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">cgrp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cgroup_taskset</span> <span class="o">*</span><span class="n">tset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">RH_KABI_REPLACE</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fork</span><span class="p">)(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fork</span><span class="p">)(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">exit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">cgrp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">old_cgrp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">bind</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cgroup</span> <span class="o">*</span><span class="n">root</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">subsys_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">early_init</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * True if this subsys uses ID. ID is not available before cgroup_init()
</span></span></span><span class="line"><span class="cl"><span class="cm">         * (not available in early_init time.)
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">use_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * If %false, this subsystem is properly hierarchical -
</span></span></span><span class="line"><span class="cl"><span class="cm">         * configuration, resource accounting and restriction on a parent
</span></span></span><span class="line"><span class="cl"><span class="cm">         * cgroup cover those of its children.  If %true, hierarchy support
</span></span></span><span class="line"><span class="cl"><span class="cm">         * is broken in some ways - some subsystems ignore hierarchy
</span></span></span><span class="line"><span class="cl"><span class="cm">         * completely while others are only implemented half-way.
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * It&#39;s now disallowed to create nested cgroups if the subsystem is
</span></span></span><span class="line"><span class="cl"><span class="cm">         * broken and cgroup core will emit a warning message on such
</span></span></span><span class="line"><span class="cl"><span class="cm">         * cases.  Eventually, all subsystems will be made properly
</span></span></span><span class="line"><span class="cl"><span class="cm">         * hierarchical and this will go away.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">broken_hierarchy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">warned_broken_hierarchy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define MAX_CGROUP_TYPE_NAMELEN 32
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Link to parent, and list entry in parent&#39;s children.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Protected by cgroup_lock()
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">cgroupfs_root</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">sibling</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* used when use_id == true */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">idr</span> <span class="n">idr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">spinlock_t</span> <span class="n">id_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* list of cftype_sets */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">cftsets</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* base cftypes, automatically [de]registered with subsys itself */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">cftype</span> <span class="o">*</span><span class="n">base_cftypes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">cftype_set</span> <span class="n">base_cftset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* should be defined only by modular subsystems */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">module</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">RH_KABI_EXTEND</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">can_fork</span><span class="p">)(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">priv_p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">RH_KABI_EXTEND</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cancel_fork</span><span class="p">)(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>	
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>cgroup_subsys</code>定义了一组操作，让各个子系统根据各自的需要去实现。这个相当于<code>C++</code>中抽象基类，然后各个特定的子系统对应<code>cgroup_subsys</code>则是实现了相应操作的子类。</p>
<p>类似的思想还被用在了<code>cgroup_subsys_state</code>中，<code>cgroup_subsys_state</code>并未定义控制信息，而只是定义了各个子系统都需要的共同信息，比如该<code>cgroup_subsys_state</code>从属的<code>cgroup</code>。然后各个子系统再根据各自的需要去定义自己的进程控制信息结构体，最后在各自的结构体中将<code>cgroup_subsys_state</code>包含进去，这样通过<code>Linux</code>内核的<code>container_of</code>等宏就可以通过<code>cgroup_subsys_state</code>来获取相应的结构体。</p>
<h3 id="几个全局变量">几个全局变量</h3>
<ul>
<li><code>init_css_set</code>是默认的<code>css_set</code>。在还没有其他<code>cgroup子系统</code>被<code>mount</code>时，它被<code>init</code>和<code>其子进程</code>来使用。</li>
<li><code>css_set_count</code>用来描述当前系统上有多少个<code>css_set</code>。</li>
<li><code>rootnode</code>是一个<code>dummy hierarchy</code>，它只有一个<code>cgroup</code>，所有的进程都属于这个<code>cgroup</code>。</li>
<li><code>dummytop</code>是一个指向<code>rootnode.top_cgroup</code>的缩写。</li>
<li><code>roots</code> 是一个链表头，将所有的<code>cgroupfs_root</code>都链接到了一起。</li>
<li><code>root_count</code>表示有多少个<code>cgroupfs_root</code>。</li>
<li><code>init_css_set_link</code>: 用于链接<code>init_css_set</code>和<code>dummytop</code>的<code>cg_cgroup_link</code>。</li>
<li><code>struct cgroup_subsys *subsys[CGROUP_SUBSYS_COUNT]</code>数组，该数组保存了所有子系统（<code>cgroup_subsys</code>）的信息</li>
</ul>
<h3 id="cgroups的初始化">cgroups的初始化</h3>
<p>在内核过程中，由于各个<code>cgroup</code>子系统的特点，<code>cgroup</code>的初始分为两部分：</p>
<ul>
<li><code>cgroup_init_early</code></li>
<li><code>cgroup_init</code></li>
</ul>
<h4 id="cgroup_init_early">cgroup_init_early</h4>
<p><code>cgroup_init_early</code>用来初始化需要尽早初始化的子系统。一般这些需要尽早初始化的子系统都包括：<code>cpuset</code>，<code>cpu</code>，<code>cpuacct</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * cgroup_init_early - cgroup initialization at system boot
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Initialize cgroups at system boot, and initialize any
</span></span></span><span class="line"><span class="cl"><span class="cm"> * subsystems that request early init.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">__init</span> <span class="nf">cgroup_init_early</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_css_set</span><span class="p">.</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_css_set</span><span class="p">.</span><span class="n">cg_links</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_css_set</span><span class="p">.</span><span class="n">tasks</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">INIT_HLIST_NODE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_css_set</span><span class="p">.</span><span class="n">hlist</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">css_set_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">init_cgroup_root</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rootnode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">root_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">init_task</span><span class="p">.</span><span class="n">cgroups</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_css_set</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">init_css_set_link</span><span class="p">.</span><span class="n">cg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_css_set</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">init_css_set_link</span><span class="p">.</span><span class="n">cgrp</span> <span class="o">=</span> <span class="n">dummytop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_css_set_link</span><span class="p">.</span><span class="n">cgrp_link_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="o">&amp;</span><span class="n">rootnode</span><span class="p">.</span><span class="n">top_cgroup</span><span class="p">.</span><span class="n">css_sets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_css_set_link</span><span class="p">.</span><span class="n">cg_link_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="o">&amp;</span><span class="n">init_css_set</span><span class="p">.</span><span class="n">cg_links</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CGROUP_SUBSYS_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="n">cgroup_subsys</span> <span class="o">*</span><span class="n">ss</span> <span class="o">=</span> <span class="n">subsys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="cm">/* at bootup time, we don&#39;t worry about modular subsystems */</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ss</span> <span class="o">||</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// 这里做了一些基本的检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">BUG_ON</span><span class="p">(</span><span class="nf">strlen</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_CGROUP_TYPE_NAMELEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">css_alloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">css_free</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">subsys_id</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&#34;cgroup: Subsys %s id == %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">ss</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">subsys_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">BUG</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">early_init</span><span class="p">)</span><span class="c1">//只有当early_init为1时，才会进行初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nf">cgroup_init_subsys</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>该函数的主要功能如下：</p>
<ul>
<li>初始化<code>init_css_set</code>中的成员变量和几个全局变量<code>css_set_count</code>、<code>root_count</code>、<code>rootnode</code>和<code>init_css_set_link</code>。</li>
<li>初始化<code>cgroup</code>子系统<code>cpuset</code>，<code>cpu</code>，<code>cpuacct</code>。</li>
</ul>
<h4 id="cgroup_init">cgroup_init</h4>
<p><code>cgroup_init</code>用来完成<code>cgroup</code>的初始化，其代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * cgroup_init - cgroup initialization
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Register cgroup filesystem and /proc file, and initialize
</span></span></span><span class="line"><span class="cl"><span class="cm"> * any subsystems that didn&#39;t request early init.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">__init</span> <span class="nf">cgroup_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>       
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">bdi_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgroup_backing_dev_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CGROUP_SUBSYS_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="n">cgroup_subsys</span> <span class="o">*</span><span class="n">ss</span> <span class="o">=</span> <span class="n">subsys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="cm">/* at bootup time, we don&#39;t worry about modular subsystems */</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ss</span> <span class="o">||</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">early_init</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">cgroup_init_subsys</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">use_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">cgroup_init_idr</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">init_css_set</span><span class="p">.</span><span class="n">subsys</span><span class="p">[</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">subsys_id</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="cm">/* Add init_css_set to the hash table */</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="nf">css_set_hash</span><span class="p">(</span><span class="n">init_css_set</span><span class="p">.</span><span class="n">subsys</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">hash_add</span><span class="p">(</span><span class="n">css_set_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_css_set</span><span class="p">.</span><span class="n">hlist</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="nf">init_root_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rootnode</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">sysfs_create_mount_point</span><span class="p">(</span><span class="n">fs_kobj</span><span class="p">,</span> <span class="s">&#34;cgroup&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgroup_fs_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sysfs_remove_mount_point</span><span class="p">(</span><span class="n">fs_kobj</span><span class="p">,</span> <span class="s">&#34;cgroup&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nf">proc_create</span><span class="p">(</span><span class="s">&#34;cgroups&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_cgroupstats_operations</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>    
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">bdi_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgroup_backing_dev_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>主要完成了如下工作：</p>
<ul>
<li>初始化了其他几个子系统</li>
<li>初始化<code>cgroup_backing_dev_info</code></li>
<li>根据<code>use_id</code>是否为<code>true</code>，进行必要的初始化</li>
<li>将<code>init_css_set</code>这个目前唯一的<code>css_set</code>添加到<code>hash</code>表<code>css_set_table</code>中</li>
<li>创建目录<code>/sys/fs/cgroup</code></li>
<li>注册<code>cgroup</code>文件系统类型</li>
<li>创建<code>/proc/cgroups</code></li>
</ul>
<h4 id="cgroup_init_subsys">cgroup_init_subsys</h4>
<p>以上两个方法中都调用了<code>cgroup_init_subsys</code>，其代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">cgroup_init_subsys</span><span class="p">(</span><span class="k">struct</span> <span class="n">cgroup_subsys</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>                                                                          
</span></span><span class="line"><span class="cl"><span class="p">{</span>                                                                                                                                        
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">cgroup_subsys_state</span> <span class="o">*</span><span class="n">css</span><span class="p">;</span>                                                                                                 
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="nf">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&#34;Initializing cgroup subsys %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>                                                                   
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgroup_mutex</span><span class="p">);</span>                                                                                                       
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="cm">/* init base cftset */</span>                                                                                                           
</span></span><span class="line"><span class="cl">        <span class="nf">cgroup_init_cftsets</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>                                                                                                         
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="cm">/* Create the top cgroup state for this subsystem */</span>                                                                             
</span></span><span class="line"><span class="cl">        <span class="nf">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rootnode</span><span class="p">.</span><span class="n">subsys_list</span><span class="p">);</span>                 <span class="c1">//只是临时添加到   rootnode.subsys_list 链表中，后面会移走的。                                                               
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ss</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rootnode</span><span class="p">;</span>                                                                                                            
</span></span><span class="line"><span class="cl">        <span class="n">css</span> <span class="o">=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="nf">css_alloc</span><span class="p">(</span><span class="n">dummytop</span><span class="p">);</span>                                                                                                   
</span></span><span class="line"><span class="cl">        <span class="cm">/* We don&#39;t handle early failures gracefully */</span>                                                                                  
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">css</span><span class="p">));</span>                                                                                                             
</span></span><span class="line"><span class="cl">        <span class="nf">init_cgroup_css</span><span class="p">(</span><span class="n">css</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">dummytop</span><span class="p">);</span>                                                                                              
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="cm">/* Update the init_css_set to contain a subsys                                                                                   
</span></span></span><span class="line"><span class="cl"><span class="cm">         * pointer to this state - since the subsystem is                                                                                
</span></span></span><span class="line"><span class="cl"><span class="cm">         * newly registered, all tasks and hence the                                                                                     
</span></span></span><span class="line"><span class="cl"><span class="cm">         * init_css_set is in the subsystem&#39;s top cgroup. */</span>                                                                             
</span></span><span class="line"><span class="cl">        <span class="n">init_css_set</span><span class="p">.</span><span class="n">subsys</span><span class="p">[</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">subsys_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">css</span><span class="p">;</span>                                                                                        
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="n">need_forkexit_callback</span> <span class="o">|=</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">fork</span> <span class="o">||</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">;</span>                                                                                  
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="cm">/* At system boot, before all subsystems have been                                                                               
</span></span></span><span class="line"><span class="cl"><span class="cm">         * registered, no tasks have been forked, so we don&#39;t                                                                            
</span></span></span><span class="line"><span class="cl"><span class="cm">         * need to invoke fork callbacks here. */</span>                                                                                        
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="nf">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_task</span><span class="p">.</span><span class="n">tasks</span><span class="p">));</span>                                                                                           
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="nf">online_css</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">dummytop</span><span class="p">));</span>                                                                                                
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgroup_mutex</span><span class="p">);</span>                                                                                                     
</span></span><span class="line"><span class="cl">                                                                                                                                         
</span></span><span class="line"><span class="cl">        <span class="cm">/* this function shouldn&#39;t be used with modular subsystems, since they                                                           
</span></span></span><span class="line"><span class="cl"><span class="cm">         * need to register a subsys_id, among other things */</span>                                                                           
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>                                                                                                              
</span></span><span class="line"><span class="cl"><span class="p">}</span>                                                                                                                                        
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>初始化<code>cgroup_subsys</code>的<code>cftsets</code></li>
<li>分配<code>css</code></li>
<li>初始化<code>dummytop</code>和<code>init_css_set</code>中对应的<code>subsys</code>数组</li>
<li>调用<code>online_css</code></li>
</ul>
<h4 id="初始化后mount前这些数据结构的关系图">初始化后mount前这些数据结构的关系图</h4>
<p>我所使用的系统为centos7，默认cgroup各个子系统的挂载是systemd完成的，由于没有办法让systemd不进行挂载，所以在系统启动之后，我们手动umount掉这些cgroup子系统的挂载，用来分析内核里的数据结构。操作方法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># #查看有哪些cgroup</span>
</span></span><span class="line"><span class="cl"><span class="c1"># mount | grep cgroup</span>
</span></span><span class="line"><span class="cl">tmpfs on /sys/fs/cgroup <span class="nb">type</span> tmpfs <span class="o">(</span>ro,nosuid,nodev,noexec,mode<span class="o">=</span>755<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/systemd <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,xattr,release_agent<span class="o">=</span>/usr/lib/systemd/systemd-cgroups-agent,name<span class="o">=</span>systemd<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/net_cls,net_prio <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,net_prio,net_cls<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/pids <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,pids<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/cpu,cpuacct <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,cpuacct,cpu<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/freezer <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,freezer<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/memory <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,memory<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/perf_event <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,perf_event<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/hugetlb <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,hugetlb<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/debug <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,debug<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/blkio <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,blkio<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/cpuset <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,cpuset<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/devices <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,devices<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # 将所有的进程都添加到各个子系统的root cgroup中</span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/systemd/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/debug/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/blkio/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/cpu,cpuacct/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/cpuset/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/net_cls,net_prio/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/devices/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/hugetlb/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/pids/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/memory/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/freezer/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo $$ &gt;  /sys/fs/cgroup/perf_event/cgroup.procs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># # 查看有哪些cgroup子系统除了root cgroup外有子cgroup</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cat /proc/cgroups </span>
</span></span><span class="line"><span class="cl"><span class="c1">#subsys_name	hierarchy	num_cgroups	enabled</span>
</span></span><span class="line"><span class="cl">cpuset		6	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">debug		2	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">cpu		4	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">cpuacct		4	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">memory		10	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">devices		7	101	<span class="m">1</span>
</span></span><span class="line"><span class="cl">freezer		11	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">net_cls		5	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">blkio		3	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">perf_event	12	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">hugetlb		8	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">pids		9	106	<span class="m">1</span>
</span></span><span class="line"><span class="cl">net_prio	5	1	<span class="m">1</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># # 从上面可以看出，pids和devices子系统已经创建了子cgroup，我们需要将其子cgroup中的进程都添加到root cgroup中</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # 并删除除root cgroup外的所有的子cgroup，效果如下，显示每个子系统上的cgroup个数为1，即剩下的root cgroup了。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cat /proc/cgroups </span>
</span></span><span class="line"><span class="cl"><span class="c1">#subsys_name	hierarchy	num_cgroups	enabled</span>
</span></span><span class="line"><span class="cl">cpuset		6	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">debug		2	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">cpu		4	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">cpuacct		4	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">memory		10	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">devices		7	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">freezer		11	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">net_cls		5	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">blkio		3	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">perf_event	12	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">hugetlb		8	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">pids		9	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl">net_prio	5	1	<span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # 完成后，卸载到这些cgroup子系统</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/net_cls,net_prio</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/pids</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/cpu,cpuacct</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/freezer</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/memory</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/perf_event</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/hugetlb</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/debug</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/blkio</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/cpuset</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/devices</span>
</span></span><span class="line"><span class="cl"><span class="c1"># umount /sys/fs/cgroup/systemd</span>
</span></span><span class="line"><span class="cl">umount: /sys/fs/cgroup/systemd: target is busy.
</span></span><span class="line"><span class="cl">        <span class="o">(</span>In some cases useful info about processes that use
</span></span><span class="line"><span class="cl">         the device is found by lsof<span class="o">(</span>8<span class="o">)</span> or fuser<span class="o">(</span>1<span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># mount | grep cgroup</span>
</span></span><span class="line"><span class="cl">tmpfs on /sys/fs/cgroup <span class="nb">type</span> tmpfs <span class="o">(</span>ro,nosuid,nodev,noexec,mode<span class="o">=</span>755<span class="o">)</span>
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/systemd <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,xattr,release_agent<span class="o">=</span>/usr/lib/systemd/systemd-cgroups-agent,name<span class="o">=</span>systemd<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，除了/sys/fs/cgroup/systemd不能umount外，其他子系统都umount成功了。此时<code>/proc/cgroups</code>的输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># cat /proc/cgroups 
</span></span><span class="line"><span class="cl">#subsys_name	hierarchy	num_cgroups	enabled
</span></span><span class="line"><span class="cl">cpuset		0	1	1
</span></span><span class="line"><span class="cl">debug		0	1	1
</span></span><span class="line"><span class="cl">cpu		0	1	1
</span></span><span class="line"><span class="cl">cpuacct		0	1	1
</span></span><span class="line"><span class="cl">memory		0	1	1
</span></span><span class="line"><span class="cl">devices		0	1	1
</span></span><span class="line"><span class="cl">freezer		0	1	1
</span></span><span class="line"><span class="cl">net_cls		0	1	1
</span></span><span class="line"><span class="cl">blkio		0	1	1
</span></span><span class="line"><span class="cl">perf_event	0	1	1
</span></span><span class="line"><span class="cl">hugetlb		0	1	1
</span></span><span class="line"><span class="cl">pids		0	1	1
</span></span><span class="line"><span class="cl">net_prio	0	1	1
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，每个子系统的hierarchy id为0，且只有一个cgroup，即dummytop这个cgroup。</p>
<p>此时，我们就可以通过crash来分析这些数据结构的关系：</p>
<ul>
<li>由于系统上挂载了systemd这个cgroup，再加上rootnode这个dummy cgrouproot_fs，总共有两个cgrouproot_fs，所以root_count=2，而只有systemd对应的cgroupfs_root被链接到了roots这个链表上。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; p root_count
</span></span><span class="line"><span class="cl">root_count = $1 = 2
</span></span><span class="line"><span class="cl">crash&gt; list -l cgroupfs_root.root_list -s cgroupfs_root.name -H roots
</span></span><span class="line"><span class="cl">ffff9d7d56f94308
</span></span><span class="line"><span class="cl">  name = &#34;systemd\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>rootnode的subsys_list应该包含了那13个未挂载的cgroup_subsys</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; struct -o cgroupfs_root.subsys_list rootnode
</span></span><span class="line"><span class="cl">struct cgroupfs_root {
</span></span><span class="line"><span class="cl">  [ffffffffa03ff020] struct list_head subsys_list;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">crash&gt; list  -l cgroup_subsys.sibling -s cgroup_subsys.name,subsys_id -H ffffffffa03ff020
</span></span><span class="line"><span class="cl">ffffffff9ebf9f70
</span></span><span class="line"><span class="cl">  name = 0xffffffff9ea9a8cc &#34;pids&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 11
</span></span><span class="line"><span class="cl">ffffffff9ec83270
</span></span><span class="line"><span class="cl">  name = 0xffffffff9eacb432 &#34;devices&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 5
</span></span><span class="line"><span class="cl">ffffffff9ebfb590
</span></span><span class="line"><span class="cl">  name = 0xffffffff9eaa6abb &#34;cpuset&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 0
</span></span><span class="line"><span class="cl">ffffffff9ec98e10
</span></span><span class="line"><span class="cl">  name = 0xffffffff9eac4e39 &#34;blkio&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 8
</span></span><span class="line"><span class="cl">ffffffff9ebf7ff0
</span></span><span class="line"><span class="cl">  name = 0xffffffff9ea99ec6 &#34;debug&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 1
</span></span><span class="line"><span class="cl">ffffffff9ed2f730
</span></span><span class="line"><span class="cl">  name = 0xffffffff9eaa7164 &#34;hugetlb&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 10
</span></span><span class="line"><span class="cl">ffffffff9ec54230
</span></span><span class="line"><span class="cl">  name = 0xffffffff9ea9e4ec &#34;perf_event&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 9
</span></span><span class="line"><span class="cl">ffffffff9ed2f590
</span></span><span class="line"><span class="cl">  name = 0xffffffff9eaaf4d8 &#34;memory&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 4
</span></span><span class="line"><span class="cl">ffffffff9ebf9df0
</span></span><span class="line"><span class="cl">  name = 0xffffffff9ea97da3 &#34;freezer&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 6
</span></span><span class="line"><span class="cl">ffffffff9ebf1050
</span></span><span class="line"><span class="cl">  name = 0xffffffff9ea97b50 &#34;cpuacct&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 3
</span></span><span class="line"><span class="cl">ffffffff9ebeda90
</span></span><span class="line"><span class="cl">  name = 0xffffffff9ea9baca &#34;cpu&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 2
</span></span><span class="line"><span class="cl">ffffffff9ece34b0
</span></span><span class="line"><span class="cl">  name = 0xffffffff9eb2289a &#34;net_prio&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 12
</span></span><span class="line"><span class="cl">ffffffff9ece3dd0
</span></span><span class="line"><span class="cl">  name = 0xffffffff9eb22a9e &#34;net_cls&#34;
</span></span><span class="line"><span class="cl">  subsys_id = 7
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>系统上这些cgroup对应的cgroup_subsys的成员root都执行了rootnode：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; struct -o cgroupfs_root.subsys_list rootnode
</span></span><span class="line"><span class="cl">struct cgroupfs_root {
</span></span><span class="line"><span class="cl">  [ffffffffa03ff020] struct list_head subsys_list;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">crash&gt; p &amp;rootnode
</span></span><span class="line"><span class="cl">$13 = (struct cgroupfs_root *) 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">crash&gt;  list  -l cgroup_subsys.sibling -s cgroup_subsys.root  -H ffffffffa03ff020
</span></span><span class="line"><span class="cl">ffffffff9ebf9f70
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ec83270
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ebfb590
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ec98e10
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ebf7ff0
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ed2f730
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ec54230
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ed2f590
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ebf9df0
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ebf1050
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ebeda90
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ece34b0
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span><span class="line"><span class="cl">ffffffff9ece3dd0
</span></span><span class="line"><span class="cl">  root = 0xffffffffa03ff000
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这个时刻，系统上只有一个css_set，即<code>init_css_set</code>, 所有的进程的css_set都执向它：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; p css_set_count
</span></span><span class="line"><span class="cl">css_set_count = $1 = 1
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>dummytop和init_css_set的成员subsys执行的css都相同：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; p &amp;rootnode.top_cgroup
</span></span><span class="line"><span class="cl">$18 = (struct cgroup *) 0xffffffffa03ff030
</span></span><span class="line"><span class="cl">crash&gt; cgroup.subsys 0xffffffffa03ff030
</span></span><span class="line"><span class="cl">  subsys = {0xffffffff9ebfb2a0, 0xffff9d7d5a913a00, 0xffffffff9f5ac1c0, 0xffffffff9ebf1560, 0xffff9d7d5a96d000, 0xffff9d7d5a919480, 0xffff9d7d5a919540, 0xffff9d7d5a913a80, 0xffffffff9ec990c0, 0xffff9d7d5a913b00, 0xffff9d7d5a919600, 0xffff9d7d5a9196c0, 0xffff9d7d5a913b80}
</span></span><span class="line"><span class="cl">crash&gt; css_set.subsys init_css_set
</span></span><span class="line"><span class="cl">  subsys = {0xffffffff9ebfb2a0, 0xffff9d7d5a913a00, 0xffffffff9f5ac1c0, 0xffffffff9ebf1560, 0xffff9d7d5a96d000, 0xffff9d7d5a919480, 0xffff9d7d5a919540, 0xffff9d7d5a913a80, 0xffffffff9ec990c0, 0xffff9d7d5a913b00, 0xffff9d7d5a919600, 0xffff9d7d5a9196c0, 0xffff9d7d5a913b80}
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以，<code>cgroup_init_early</code> 和<code>cgroup_init</code> 执行完后，这些数据结构之间的关系如下图所示：</p>
<p><img src="./cgroup_init.svg" alt="enter description here" title="cgroup_init"></p>
<h3 id="proccgroups-实现分析">/proc/cgroups 实现分析</h3>
<p>在<code>cgroup</code>初始化函数<code>cgroup_init</code>中会调用如下函数进行注册<code>/proc/cgroups</code>接口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">__init</span> <span class="nf">cgroup_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">		<span class="nf">proc_create</span><span class="p">(</span><span class="s">&#34;cgroups&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_cgroupstats_operations</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>proc_cgroupstats_operations</code>的实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Display information about each subsystem and each hierarchy */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_cgroupstats_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&#34;#subsys_name</span><span class="se">\t</span><span class="s">hierarchy</span><span class="se">\t</span><span class="s">num_cgroups</span><span class="se">\t</span><span class="s">enabled</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*   
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ideally we don&#39;t want subsystems moving around while we do this.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * cgroup_mutex is also necessary to guarantee an atomic snapshot of
</span></span></span><span class="line"><span class="cl"><span class="cm">         * subsys/hierarchy state.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgroup_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CGROUP_SUBSYS_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="n">cgroup_subsys</span> <span class="o">*</span><span class="n">ss</span> <span class="o">=</span> <span class="n">subsys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="c1">// ss 可能为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&#34;%s</span><span class="se">\t</span><span class="s">%d</span><span class="se">\t</span><span class="s">%d</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">ss</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ss</span><span class="o">-&gt;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">hierarchy_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">ss</span><span class="o">-&gt;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">number_of_cgroups</span><span class="p">,</span> <span class="o">!</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>    
</span></span><span class="line"><span class="cl">        <span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgroup_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">cgroupstats_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">proc_cgroupstats_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_cgroupstats_operations</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">cgroupstats_open</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从上可以看出，这些信息都来自于数组<code>subsys</code>和其成员<code>subsys-&gt;root</code>（类型为<code>cgroupfs_root</code>）。<code>/proc/cgroups</code>示例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">~  <span class="c1"># cat /proc/cgroups</span>
</span></span><span class="line"><span class="cl"><span class="c1">#subsys_name    hierarchy       num_cgroups     enabled</span>
</span></span><span class="line"><span class="cl">cpuset  	<span class="m">3</span>       <span class="m">2</span>       <span class="m">1</span>
</span></span><span class="line"><span class="cl">debug   	<span class="m">4</span>       <span class="m">3</span>       <span class="m">1</span>
</span></span><span class="line"><span class="cl">cpu     	<span class="m">5</span>       <span class="m">40</span>      <span class="m">1</span>
</span></span><span class="line"><span class="cl">cpuacct 	<span class="m">5</span>       <span class="m">40</span>      <span class="m">1</span>
</span></span><span class="line"><span class="cl">memory  	<span class="m">2</span>       <span class="m">44</span>      <span class="m">1</span>
</span></span><span class="line"><span class="cl">devices 	<span class="m">11</span>      <span class="m">42</span>      <span class="m">1</span>
</span></span><span class="line"><span class="cl">freezer 	<span class="m">10</span>      <span class="m">2</span>       <span class="m">1</span>
</span></span><span class="line"><span class="cl">net_cls 	<span class="m">12</span>      <span class="m">2</span>       <span class="m">1</span>
</span></span><span class="line"><span class="cl">blkio   	<span class="m">8</span>       <span class="m">42</span>      <span class="m">1</span>
</span></span><span class="line"><span class="cl">perf_event      <span class="m">6</span>       <span class="m">2</span>       <span class="m">1</span>
</span></span><span class="line"><span class="cl">hugetlb 	<span class="m">7</span>       <span class="m">2</span>       <span class="m">1</span>
</span></span><span class="line"><span class="cl">pids    	<span class="m">9</span>       <span class="m">109</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">net_prio        <span class="m">12</span>      <span class="m">2</span>       <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从上可以看出，</p>
<ul>
<li>第一列是<code>cgroup</code>子系统的名称</li>
<li>第二列的<code>hierarchy</code>从<code>2</code>开始，那么编号为<code>1</code>的<code>hierarchy</code>是什么呢？<code>hierarchy_id</code>是动态分配，<code>linux</code>系统启动时，先挂载了一个未附加任何子系统的层级<code>systemd</code>,所以<code>systemd</code>的<code>hierarchy_id</code>为1</li>
<li>第三列说明该子系统中<code>cgroups</code>的个数</li>
<li>第四列说明该子系统是否使能。</li>
</ul>
<p>内核中数组<code>subsys</code>保存了系统上的不同的<code>cgroup</code>子系统信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define SUBSYS(_x) [_x ## _subsys_id] = &amp;_x ## _subsys,
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IS_SUBSYS_ENABLED(option) IS_BUILTIN(option)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ENABLE_NETPRIO_NOW
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">static</span> <span class="k">struct</span> <span class="n">cgroup_subsys</span> <span class="o">*</span><span class="n">subsys</span><span class="p">[</span><span class="n">CGROUP_SUBSYS_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/cgroup_subsys.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cp">#undef ENABLE_NETPRIO_NOW
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中<code>CGROUP_SUBSYS_COUNT</code>的值为系统上支持的<code>cgroup</code>的个数，包括编译进内核的和编译成模块的。</p>
<blockquote>
<p>注意，由于<code>IS_SUBSYS_ENABLED</code>的定义，这里只会初始化编译进内核模块的子cgroup。</p>
</blockquote>
<p>使用<code>crash</code>工具，可以查看内核中<code>cgroup</code>子系统的情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; p subsys[0].name
</span></span><span class="line"><span class="cl">$5 = 0xffffffffa3ea6abb &#34;cpuset&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[1].name
</span></span><span class="line"><span class="cl">$6 = 0xffffffffa3e99ec6 &#34;debug&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[2].name
</span></span><span class="line"><span class="cl">$7 = 0xffffffffa3e9baca &#34;cpu&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[3].name
</span></span><span class="line"><span class="cl">$8 = 0xffffffffa3e97b50 &#34;cpuacct&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[4].name
</span></span><span class="line"><span class="cl">$9 = 0xffffffffa3eaf4d8 &#34;memory&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[5].name
</span></span><span class="line"><span class="cl">$10 = 0xffffffffa3ecb432 &#34;devices&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[6].name
</span></span><span class="line"><span class="cl">$11 = 0xffffffffa3e97da3 &#34;freezer&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[7].name
</span></span><span class="line"><span class="cl">$12 = 0xffffffffa3f22a9e &#34;net_cls&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[8].name
</span></span><span class="line"><span class="cl">$13 = 0xffffffffa3ec4e39 &#34;blkio&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[9].name
</span></span><span class="line"><span class="cl">$14 = 0xffffffffa3e9e4ec &#34;perf_event&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[10].name
</span></span><span class="line"><span class="cl">$15 = 0xffffffffa3ea7164 &#34;hugetlb&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[11].name
</span></span><span class="line"><span class="cl">$16 = 0xffffffffa3e9a8cc &#34;pids&#34;
</span></span><span class="line"><span class="cl">crash&gt; p subsys[12].name
</span></span><span class="line"><span class="cl">$17 = 0xffffffffa3f2289a &#34;net_prio&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>在内核中，每个<code>cgroup</code>子系统，都会有一个<code>subsys</code>的定义的结构体。对于<code>pids</code>子系统，其对应的<code>subsys</code>定义为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">cgroup_subsys</span> <span class="n">pids_subsys</span> <span class="o">=</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&#34;pids&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">subsys_id</span>      <span class="o">=</span> <span class="n">pids_subsys_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">css_alloc</span>      <span class="o">=</span> <span class="n">pids_css_alloc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">css_free</span>       <span class="o">=</span> <span class="n">pids_css_free</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">can_attach</span>     <span class="o">=</span> <span class="n">pids_can_attach</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cancel_attach</span>  <span class="o">=</span> <span class="n">pids_cancel_attach</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">can_fork</span>       <span class="o">=</span> <span class="n">pids_can_fork</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cancel_fork</span>    <span class="o">=</span> <span class="n">pids_cancel_fork</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">fork</span>           <span class="o">=</span> <span class="n">pids_fork</span><span class="p">,</span>                                                                                                           
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">exit</span>           <span class="o">=</span> <span class="n">pids_exit</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">base_cftypes</span>   <span class="o">=</span> <span class="n">pids_files</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="crash-查看cgroup的一些数据结构的关系">crash 查看cgroup的一些数据结构的关系</h3>
<blockquote>
<p>NOTE:  这里是centos 7启动后，默认情况下，各个cgroup子系统都已经被systemd挂载的情况。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; struct -o cgroupfs_root rootnode
</span></span><span class="line"><span class="cl">struct cgroupfs_root {
</span></span><span class="line"><span class="cl">  [ffffffffa57ff000] struct super_block *sb;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff008] unsigned long subsys_mask;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff010] int hierarchy_id;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff018] unsigned long actual_subsys_mask;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff020] struct list_head subsys_list;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff030] struct cgroup top_cgroup;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff300] int number_of_cgroups;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff308] struct list_head root_list;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff318] struct list_head allcg_list;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff328] unsigned long flags;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff330] struct ida cgroup_ida;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff3a8] char release_agent_path[4096];
</span></span><span class="line"><span class="cl">  [ffffffffa58003a8] char name[64];
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">SIZE: 5096
</span></span><span class="line"><span class="cl">crash&gt; list -l cgroup.allcg_node -s cgroup.name,id,root,count -H ffffffffa57ff318
</span></span><span class="line"><span class="cl">ffffffffa57ff108
</span></span><span class="line"><span class="cl">  name = 0xffffffffa3ff9740
</span></span><span class="line"><span class="cl">  id = 0
</span></span><span class="line"><span class="cl">  root = 0xffffffffa57ff000
</span></span><span class="line"><span class="cl">  count = {
</span></span><span class="line"><span class="cl">    counter = 47
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">crash&gt; cgroup_name.name 0xffffffffa3ff9740
</span></span><span class="line"><span class="cl">  name = 0xffffffffa3ff9750 &#34;/&#34;
</span></span><span class="line"><span class="cl">crash&gt; p rootnode.number_of_cgroups
</span></span><span class="line"><span class="cl">$1 = 1
</span></span></code></pre></td></tr></table>
</div>
</div><p>从上可以看出，<code>rootnode</code>的成员<code>allcg_list</code>将属于该<code>cgroupfs_root</code>的所有的<code>cgroup</code>的链接到了一起，一般情况下，系统上属于<code>rootnode</code>的<code>cgroup</code>只有一个，即<code>dummy_top</code>，其名称为<code>/</code>。</p>
<p>当系统<code>mount</code>很多<code>cgroup</code> 层级后，全局变量<code>roots</code>作为链表头，将系统上所有的层级都链接到了一起。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; list -l cgroupfs_root.root_list  -s cgroupfs_root.hierarchy_id,name,actual_subsys_mask -H roots
</span></span><span class="line"><span class="cl">ffff9047143be308
</span></span><span class="line"><span class="cl">  hierarchy_id = 12
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 4224
</span></span><span class="line"><span class="cl">ffff9047143b8308
</span></span><span class="line"><span class="cl">  hierarchy_id = 11
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 32
</span></span><span class="line"><span class="cl">ffff9047143ba308
</span></span><span class="line"><span class="cl">  hierarchy_id = 10
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 64
</span></span><span class="line"><span class="cl">ffff9047143bc308
</span></span><span class="line"><span class="cl">  hierarchy_id = 9
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 2048
</span></span><span class="line"><span class="cl">ffff9047143c0308
</span></span><span class="line"><span class="cl">  hierarchy_id = 8
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 256
</span></span><span class="line"><span class="cl">ffff9047143c2308
</span></span><span class="line"><span class="cl">  hierarchy_id = 7
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 1024
</span></span><span class="line"><span class="cl">ffff9047143c4308
</span></span><span class="line"><span class="cl">  hierarchy_id = 6
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 512
</span></span><span class="line"><span class="cl">ffff9047143c6308
</span></span><span class="line"><span class="cl">  hierarchy_id = 5
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 12
</span></span><span class="line"><span class="cl">ffff90471418c308
</span></span><span class="line"><span class="cl">  hierarchy_id = 4
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 2
</span></span><span class="line"><span class="cl">ffff90471418e308
</span></span><span class="line"><span class="cl">  hierarchy_id = 3
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 1
</span></span><span class="line"><span class="cl">ffff904714188308
</span></span><span class="line"><span class="cl">  hierarchy_id = 2
</span></span><span class="line"><span class="cl">  name = &#34;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 16
</span></span><span class="line"><span class="cl">ffff90471418a308
</span></span><span class="line"><span class="cl">  hierarchy_id = 1
</span></span><span class="line"><span class="cl">  name = &#34;systemd\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&#34;
</span></span><span class="line"><span class="cl">  actual_subsys_mask = 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，<code>roots</code>这个链表将系统上所有的<code>cgroupfs_root</code>链接到了一起，注意，这个链表中不包括<code>rootnode</code>这个<code>cgroupfs_root</code>,因为这个<code>rootnode</code>的<code>hierarchy_id</code>为<code>0</code>，这个链表中没有<code>hierarchy_id</code>为<code>0</code>的结点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; p rootnode.hierarchy_id
</span></span><span class="line"><span class="cl">$1 = 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>关于<code>dummytop</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">crash&gt; struct -o cgroupfs_root.top_cgroup  rootnode
</span></span><span class="line"><span class="cl">struct cgroupfs_root {
</span></span><span class="line"><span class="cl">  [ffffffffa57ff030] struct cgroup top_cgroup;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">crash&gt; struct -o cgroup ffffffffa57ff030
</span></span><span class="line"><span class="cl">struct cgroup {
</span></span><span class="line"><span class="cl">  [ffffffffa57ff030] unsigned long flags;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff038] atomic_t count;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff03c] int id;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff040] struct list_head sibling;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff050] struct list_head children;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff060] struct list_head files;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff070] struct cgroup *parent;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff078] struct dentry *dentry;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff080] struct cgroup_name *name;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff088] struct cgroup_subsys_state *subsys[13];
</span></span><span class="line"><span class="cl">  [ffffffffa57ff0f0] struct cgroupfs_root *root;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff0f8] struct list_head css_sets;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff108] struct list_head allcg_node;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff118] struct list_head cft_q_node;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff128] struct list_head release_list;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff138] struct list_head pidlists;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff148] struct mutex pidlist_mutex;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff1f0] struct callback_head callback_head;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff200] struct work_struct free_work;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff250] struct list_head event_list;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff260] spinlock_t event_list_lock;
</span></span><span class="line"><span class="cl">  [ffffffffa57ff2a8] struct simple_xattrs xattrs;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">SIZE: 720
</span></span><span class="line"><span class="cl">crash&gt; list -H ffffffffa57ff040
</span></span><span class="line"><span class="cl">(empty)
</span></span><span class="line"><span class="cl">crash&gt; list -H ffffffffa57ff050
</span></span><span class="line"><span class="cl">(empty)
</span></span><span class="line"><span class="cl">crash&gt; list -H ffffffffa57ff060
</span></span><span class="line"><span class="cl">(empty)
</span></span><span class="line"><span class="cl">crash&gt; p rootnode.top_cgroup.subsys
</span></span><span class="line"><span class="cl">$2 = {0xffffffffa3ffb2a0, 0xffff90471e913a00, 0xffffffffa49ac1c0, 0xffffffffa3ff1560, 0xffff90471e96d000, 0xffff90471e919480, 0xffff90471e919540, 0xffff90471e913a80, 0xffffffffa40990c0, 0xffff90471e913b00, 0xffff90471e919600, 0xffff90471e9196c0, 0xffff90471e913b80}
</span></span><span class="line"><span class="cl">crash&gt; p rootnode.top_cgroup.name
</span></span><span class="line"><span class="cl">$3 = (struct cgroup_name *) 0xffffffffa3ff9740
</span></span><span class="line"><span class="cl">crash&gt; cgroup_name.name 0xffffffffa3ff9740
</span></span><span class="line"><span class="cl">  name = 0xffffffffa3ff9750 &#34;/&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>dummytop</code> 是一个特殊的<code>cgroup</code>，其没有兄弟和孩子<code>cgroup</code>，其<code>subsys</code>包含了所有的控制子系统，即<code>rootnode.top_cgroup.subsys</code>数组中每个成员都不为<code>null</code>。这些<code>css</code>是在<code>cgroup_init_subsys</code>函数中创建的。初始化时这些<code>css</code>的<code>cgroup</code>成员都指向了<code>dummytop</code>，在后续<code>mount</code>各个<code>cgroup</code>子系统时会进行调整。即<code>mount</code>时会创建新的<code>cgroupfs_root</code>, 并将对应的<code>subsys</code>跟新创建的<code>cgroupfs_root</code>建立对应的关系，当<code>umount</code>或者<code>remount</code>时，需要删除的子系统，将会移动到<code>rootnode</code>这个<code>cgroupfs_root</code>中。</p>
<h3 id="cgroup-subsys中的use_id">cgroup subsys中的use_id</h3>
<p>只有<code>memory cgroup</code>中的<code>use_id</code>为<code>true</code>。</p>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">laoqinren</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2018-08-23
        
    </span>
  </p>
  <p class="copyright-item">
      <span class="item-title">Markdown</span>
      <span class="item-content"><a class="link-to-markdown" href="http://linux.laoqinren.net/kernel/cgroup-source-cgroup_init/index.md" target="_blank">The Markdown version »</a></span>
    </p>
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kernel/">kernel</a>
          <a href="/tags/linux/">linux</a>
          <a href="/tags/cgroup/">cgroup</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/kernel/cgroup-source-cgroup_mount/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">cgroup源码分析3——cgroup层级的mount流程</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/kernel/cgroup-source-css_set-and-cgroup/">
            <span class="next-text nav-default">cgroup源码分析1—— css_set和cgroup的关系</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'laoqinren';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:w@laoqinren.net" class="iconfont icon-email" title="email"></a>
      <a href="http://github.com/0x0916" class="iconfont icon-github" title="github"></a>
  <a href="http://linux.laoqinren.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>laoqinren</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
